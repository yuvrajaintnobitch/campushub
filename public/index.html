<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusHub - College Club & Event Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6C5CE7;
            --primary-light: #A29BFE;
            --secondary: #00CEC9;
            --accent: #FD79A8;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #D63031;
            --dark: #0A0A1A;
            --dark-card: #12122A;
            --dark-lighter: #1A1A3E;
            --dark-border: #2D2D5E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0D0;
            --text-muted: #6C6C9E;
            --gradient-primary: linear-gradient(135deg, #6C5CE7, #A29BFE);
            --gradient-accent: linear-gradient(135deg, #FD79A8, #E84393);
            --gradient-success: linear-gradient(135deg, #00B894, #55EFC4);
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
            --shadow-hover: 0 8px 40px rgba(108,92,231,0.3);
            --radius: 16px;
            --radius-sm: 10px;
            --radius-full: 50px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
        }
        a { text-decoration: none; color: inherit; }
        button { cursor: pointer; border: none; font-family: inherit; }
        input, textarea, select { font-family: inherit; outline: none; border: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--dark); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

        /* AUTH */
        .auth-container {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            padding: 20px; background: var(--dark); position: relative;
        }
        .auth-container::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(ellipse at 30% 20%, rgba(108,92,231,0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(253,121,168,0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translate(0,0); } 50% { transform: translate(-20px,-20px); } }
        .auth-card {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            padding: 40px; width: 100%; max-width: 440px; position: relative; z-index: 1; box-shadow: var(--shadow);
        }
        .auth-card h1 {
            font-size: 28px; font-weight: 800; text-align: center; margin-bottom: 8px;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .auth-card .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 32px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary);
            margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px 16px; background: var(--dark-lighter); border: 1px solid var(--dark-border);
            border-radius: var(--radius-sm); color: var(--text-primary); font-size: 15px; transition: all 0.3s;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108,92,231,0.2);
        }
        .form-group select option { background: var(--dark-card); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-primary {
            width: 100%; padding: 14px; background: var(--gradient-primary); color: white;
            font-size: 16px; font-weight: 700; border-radius: var(--radius-sm); transition: all 0.3s; margin-top: 8px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .auth-toggle { text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px; }
        .auth-toggle a { color: var(--primary-light); font-weight: 600; cursor: pointer; }
        .auth-toggle a:hover { text-decoration: underline; }
        .error-msg {
            background: rgba(214,48,49,0.1); border: 1px solid rgba(214,48,49,0.3); color: #FF6B6B;
            padding: 10px 14px; border-radius: var(--radius-sm); font-size: 13px; margin-bottom: 16px; display: none;
        }
        .error-msg.show { display: block; }
        .role-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .role-option {
            flex: 1; padding: 12px; background: var(--dark-lighter); border: 2px solid var(--dark-border);
            border-radius: var(--radius-sm); text-align: center; cursor: pointer; transition: all 0.3s;
            font-size: 13px; font-weight: 600;
        }
        .role-option.active { border-color: var(--primary); background: rgba(108,92,231,0.15); }
        .role-option .role-icon { font-size: 24px; display: block; margin-bottom: 4px; }

        /* LAYOUT */
        .app-container { display: none; }
        .app-container.active { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: var(--dark-card); border-right: 1px solid var(--dark-border);
            display: flex; flex-direction: column; position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; transition: transform 0.3s;
        }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid var(--dark-border); }
        .sidebar-header h2 {
            font-size: 22px; font-weight: 800;
            background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .sidebar-header .user-role { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }
        .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }
        .nav-section-title {
            font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 1.5px; padding: 12px 12px 6px;
        }
        .nav-item {
            display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: var(--radius-sm);
            color: var(--text-secondary); font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
            margin-bottom: 2px; position: relative;
        }
        .nav-item:hover { background: var(--dark-lighter); color: var(--text-primary); }
        .nav-item.active { background: rgba(108,92,231,0.15); color: var(--primary-light); }
        .nav-item i { width: 20px; text-align: center; font-size: 15px; }
        .nav-badge {
            position: absolute; right: 12px; background: var(--danger); color: white;
            font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 10px; min-width: 18px; text-align: center;
        }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--dark-border); }
        .user-profile-mini { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: var(--radius-sm); cursor: pointer; transition: background 0.2s; }
        .user-profile-mini:hover { background: var(--dark-lighter); }
        .user-avatar {
            width: 38px; height: 38px; border-radius: 50%; background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 15px;
        }
        .user-info .user-name { font-size: 14px; font-weight: 600; }
        .user-info .user-email { font-size: 11px; color: var(--text-muted); }

        /* Main */
        .main-content { flex: 1; margin-left: 260px; min-height: 100vh; }
        .top-bar {
            display: flex; align-items: center; justify-content: space-between; padding: 16px 32px;
            background: var(--dark-card); border-bottom: 1px solid var(--dark-border); position: sticky; top: 0; z-index: 50;
        }
        .top-bar-left { display: flex; align-items: center; gap: 16px; }
        .menu-toggle { display: none; background: none; color: var(--text-primary); font-size: 20px; padding: 8px; }
        .page-title { font-size: 20px; font-weight: 700; }
        .top-bar-right { display: flex; align-items: center; gap: 16px; }
        .search-bar {
            display: flex; align-items: center; background: var(--dark-lighter); border: 1px solid var(--dark-border);
            border-radius: var(--radius-full); padding: 8px 16px; width: 280px;
        }
        .search-bar i { color: var(--text-muted); margin-right: 8px; font-size: 14px; }
        .search-bar input { background: none; color: var(--text-primary); font-size: 13px; width: 100%; }
        .icon-btn {
            width: 40px; height: 40px; border-radius: 50%; background: var(--dark-lighter); color: var(--text-secondary);
            display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; position: relative;
        }
        .icon-btn:hover { background: var(--dark-border); color: var(--text-primary); }
        .icon-btn .badge {
            position: absolute; top: -2px; right: -2px; background: var(--danger); color: white;
            font-size: 9px; font-weight: 700; width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-logout {
            padding: 8px 16px; background: rgba(214,48,49,0.15); color: #FF6B6B;
            border-radius: var(--radius-full); font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .btn-logout:hover { background: rgba(214,48,49,0.3); }
        .page-content { padding: 32px; }
        .page { display: none; }
        .page.active { display: block; }

        /* STATS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            padding: 24px; transition: all 0.3s;
        }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .stat-card .stat-icon {
            width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; font-size: 22px; margin-bottom: 16px;
        }
        .stat-card .stat-value { font-size: 28px; font-weight: 800; }
        .stat-card .stat-label { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

        /* CLUBS */
        .clubs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .club-card {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            overflow: hidden; transition: all 0.3s; cursor: pointer;
        }
        .club-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); border-color: var(--primary); }
        .club-card-banner { height: 80px; display: flex; align-items: center; justify-content: center; font-size: 36px; }
        .club-card-body { padding: 20px; }
        .club-card-body h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .club-card-body p {
            font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 16px;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .club-card-meta { display: flex; align-items: center; justify-content: space-between; }
        .club-card-meta .members { font-size: 12px; color: var(--text-muted); }
        .club-card-meta .members i { margin-right: 4px; }
        .club-card-meta .rating { font-size: 12px; color: var(--warning); }
        .club-card-meta .rating i { margin-right: 3px; }
        .badge-category {
            display: inline-block; padding: 4px 10px; border-radius: var(--radius-full);
            font-size: 11px; font-weight: 600; margin-bottom: 12px;
        }
        .club-card-actions { padding: 12px 20px; border-top: 1px solid var(--dark-border); display: flex; gap: 8px; }
        .btn-sm {
            padding: 8px 16px; border-radius: var(--radius-full); font-size: 12px; font-weight: 600;
            transition: all 0.2s; flex: 1; text-align: center;
        }
        .btn-join { background: var(--gradient-primary); color: white; }
        .btn-join:hover { box-shadow: var(--shadow-hover); }
        .btn-joined { background: rgba(0,184,148,0.15); color: var(--success); }
        .btn-pending { background: rgba(253,203,110,0.15); color: var(--warning); }
        .btn-view { background: var(--dark-lighter); color: var(--text-secondary); }
        .btn-view:hover { color: var(--text-primary); }
        .btn-leave { background: rgba(214,48,49,0.15); color: #FF6B6B; }

        /* EVENTS */
        .events-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .event-card {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            overflow: hidden; transition: all 0.3s;
        }
        .event-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .event-card-banner { height: 60px; display: flex; align-items: center; padding: 0 20px; gap: 12px; }
        .event-card-banner .event-icon { font-size: 28px; }
        .event-card-banner .event-club { font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 600; }
        .event-card-body { padding: 20px; }
        .event-card-body h3 { font-size: 17px; font-weight: 700; margin-bottom: 12px; }
        .event-detail { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .event-detail i { width: 16px; color: var(--primary-light); }
        .event-card-footer {
            padding: 12px 20px; border-top: 1px solid var(--dark-border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .event-spots { font-size: 12px; color: var(--text-muted); }
        .event-price { font-size: 13px; font-weight: 700; color: var(--success); }

        /* NOTIFICATIONS */
        .notification-list { display: flex; flex-direction: column; gap: 8px; }
        .notification-item {
            display: flex; align-items: flex-start; gap: 14px; padding: 16px;
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius-sm); transition: all 0.2s;
        }
        .notification-item.unread { border-left: 3px solid var(--primary); background: rgba(108,92,231,0.05); }
        .notification-item .notif-icon { font-size: 24px; flex-shrink: 0; }
        .notification-item .notif-content { flex: 1; }
        .notification-item .notif-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .notification-item .notif-msg { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .notification-item .notif-time { font-size: 11px; color: var(--text-muted); }

        /* CHAT */
        .chat-container {
            display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 140px);
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius); overflow: hidden;
        }
        .chat-channels { border-right: 1px solid var(--dark-border); overflow-y: auto; }
        .chat-channels-header { padding: 20px; font-size: 16px; font-weight: 700; border-bottom: 1px solid var(--dark-border); }
        .channel-item {
            display: flex; align-items: center; gap: 12px; padding: 14px 20px; cursor: pointer;
            transition: background 0.2s; border-bottom: 1px solid var(--dark-border);
        }
        .channel-item:hover, .channel-item.active { background: rgba(108,92,231,0.1); }
        .channel-icon {
            width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center;
            justify-content: center; font-size: 20px;
        }
        .channel-info { flex: 1; overflow: hidden; }
        .channel-name { font-size: 14px; font-weight: 600; }
        .channel-last-msg { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-main { display: flex; flex-direction: column; }
        .chat-header { padding: 16px 24px; border-bottom: 1px solid var(--dark-border); font-size: 16px; font-weight: 700; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 24px; display: flex; flex-direction: column; gap: 12px; }
        .chat-msg { display: flex; gap: 10px; max-width: 70%; }
        .chat-msg.own { margin-left: auto; flex-direction: row-reverse; }
        .chat-msg-avatar {
            width: 32px; height: 32px; border-radius: 50%; background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;
        }
        .chat-msg-bubble { background: var(--dark-lighter); padding: 10px 14px; border-radius: 14px; border-top-left-radius: 4px; }
        .chat-msg.own .chat-msg-bubble { background: var(--primary); border-top-left-radius: 14px; border-top-right-radius: 4px; }
        .chat-msg-sender { font-size: 11px; font-weight: 600; color: var(--primary-light); margin-bottom: 2px; }
        .chat-msg.own .chat-msg-sender { color: rgba(255,255,255,0.7); }
        .chat-msg-text { font-size: 14px; line-height: 1.4; }
        .chat-msg-time { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
        .chat-input-area { padding: 16px 24px; border-top: 1px solid var(--dark-border); display: flex; gap: 12px; align-items: center; }
        .chat-input {
            flex: 1; padding: 12px 18px; background: var(--dark-lighter); border: 1px solid var(--dark-border);
            border-radius: var(--radius-full); color: var(--text-primary); font-size: 14px;
        }
        .chat-input:focus { border-color: var(--primary); }
        .chat-send-btn {
            width: 44px; height: 44px; border-radius: 50%; background: var(--gradient-primary); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 16px; transition: transform 0.2s;
        }
        .chat-send-btn:hover { transform: scale(1.05); }
        .chat-no-channel { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 15px; }

        /* ADMIN */
        .admin-section { display: none; }
        .admin-section.show { display: block; }
        .pending-list { display: flex; flex-direction: column; gap: 12px; }
        .pending-item {
            display: flex; align-items: center; justify-content: space-between; padding: 16px 20px;
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius-sm);
        }
        .pending-item .pending-info { display: flex; align-items: center; gap: 12px; }
        .pending-item .pending-avatar {
            width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-accent);
            display: flex; align-items: center; justify-content: center; font-weight: 700;
        }
        .pending-item .pending-name { font-weight: 600; }
        .pending-item .pending-detail { font-size: 12px; color: var(--text-muted); }
        .pending-actions { display: flex; gap: 8px; }
        .btn-approve {
            padding: 6px 14px; background: var(--gradient-success); color: white;
            border-radius: var(--radius-full); font-size: 12px; font-weight: 600;
        }
        .btn-reject {
            padding: 6px 14px; background: rgba(214,48,49,0.2); color: #FF6B6B;
            border-radius: var(--radius-full); font-size: 12px; font-weight: 600;
        }

        /* CALENDAR */
        .calendar-container {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            overflow: hidden; margin-bottom: 24px;
        }
        .calendar-header-bar {
            display: flex; align-items: center; justify-content: space-between; padding: 20px 24px;
            border-bottom: 1px solid var(--dark-border);
        }
        .calendar-header-bar h3 { font-size: 18px; font-weight: 700; }
        .calendar-nav { display: flex; gap: 8px; }
        .calendar-nav button {
            width: 36px; height: 36px; border-radius: 50%; background: var(--dark-lighter);
            color: var(--text-secondary); display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        .calendar-nav button:hover { background: var(--primary); color: white; }
        .calendar-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr); padding: 12px 16px;
            border-bottom: 1px solid var(--dark-border);
        }
        .calendar-weekdays span {
            text-align: center; font-size: 11px; font-weight: 700; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); padding: 8px 16px 16px; gap: 4px; }
        .calendar-day {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--text-secondary);
            cursor: pointer; transition: all 0.2s; position: relative; min-height: 44px;
        }
        .calendar-day:hover { background: var(--dark-lighter); }
        .calendar-day.today { background: rgba(108,92,231,0.2); color: var(--primary-light); font-weight: 700; }
        .calendar-day.has-event { color: var(--text-primary); font-weight: 600; }
        .calendar-day.has-event::after {
            content: ''; position: absolute; bottom: 6px; width: 6px; height: 6px;
            border-radius: 50%; background: var(--primary);
        }
        .calendar-day.other-month { color: var(--text-muted); opacity: 0.4; }
        .calendar-day.selected { background: var(--primary); color: white; }
        .calendar-day.selected::after { background: white; }
        .calendar-events-panel {
            padding: 20px 24px; border-top: 1px solid var(--dark-border);
        }
        .calendar-events-panel h4 { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-secondary); }
        .cal-event-item {
            display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--dark-lighter);
            border-radius: var(--radius-sm); margin-bottom: 8px; transition: all 0.2s;
        }
        .cal-event-item:hover { background: var(--dark-border); }
        .cal-event-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .cal-event-info { flex: 1; }
        .cal-event-title { font-size: 13px; font-weight: 600; }
        .cal-event-time { font-size: 11px; color: var(--text-muted); }

        /* CERTIFICATES */
        .certificates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .cert-card {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            overflow: hidden; transition: all 0.3s;
        }
        .cert-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-hover); }
        .cert-card-top {
            padding: 24px; text-align: center;
            background: linear-gradient(135deg, rgba(108,92,231,0.15), rgba(253,121,168,0.1));
            border-bottom: 1px solid var(--dark-border);
        }
        .cert-card-top .cert-icon { font-size: 48px; margin-bottom: 8px; }
        .cert-card-top h3 { font-size: 16px; font-weight: 700; }
        .cert-card-top .cert-type { font-size: 12px; color: var(--primary-light); font-weight: 600; text-transform: uppercase; margin-top: 4px; }
        .cert-card-body { padding: 20px; }
        .cert-detail { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--dark-border); font-size: 13px; }
        .cert-detail:last-child { border-bottom: none; }
        .cert-detail .cert-label { color: var(--text-muted); }
        .cert-detail .cert-value { font-weight: 600; }
        .cert-card-actions { padding: 12px 20px; border-top: 1px solid var(--dark-border); display: flex; gap: 8px; }
        .btn-download {
            flex: 1; padding: 10px; background: var(--gradient-primary); color: white; border-radius: var(--radius-full);
            font-size: 13px; font-weight: 600; text-align: center; transition: all 0.2s;
        }
        .btn-download:hover { box-shadow: var(--shadow-hover); }
        .btn-verify {
            padding: 10px 16px; background: var(--dark-lighter); color: var(--text-secondary);
            border-radius: var(--radius-full); font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        .btn-verify:hover { color: var(--text-primary); }
        .verify-box {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            padding: 32px; text-align: center; margin-bottom: 24px;
        }
        .verify-box h3 { margin-bottom: 16px; }
        .verify-input-group { display: flex; gap: 12px; max-width: 400px; margin: 0 auto; }
        .verify-input-group input { flex: 1; }
        .verify-result {
            margin-top: 16px; padding: 16px; border-radius: var(--radius-sm); display: none;
        }
        .verify-result.show { display: block; }
        .verify-result.valid { background: rgba(0,184,148,0.1); border: 1px solid rgba(0,184,148,0.3); color: var(--success); }
        .verify-result.invalid { background: rgba(214,48,49,0.1); border: 1px solid rgba(214,48,49,0.3); color: #FF6B6B; }

        /* CREATE EVENT FORM */
        .create-event-section {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            padding: 32px; margin-bottom: 32px;
        }
        .create-event-section h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }

        /* SECTION HEADERS */
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .section-header h2 { font-size: 22px; font-weight: 700; }
        .filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
        .filter-btn {
            padding: 8px 16px; background: var(--dark-card); border: 1px solid var(--dark-border);
            border-radius: var(--radius-full); color: var(--text-secondary); font-size: 13px; font-weight: 500; transition: all 0.2s;
        }
        .filter-btn.active, .filter-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* PROFILE */
        .profile-header {
            display: flex; align-items: center; gap: 24px; padding: 32px;
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius); margin-bottom: 24px;
        }
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: var(--gradient-primary);
            display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 800;
        }
        .profile-details h2 { font-size: 24px; font-weight: 700; }
        .profile-details .profile-email { color: var(--text-secondary); font-size: 14px; }
        .profile-details .profile-meta { display: flex; gap: 16px; margin-top: 8px; font-size: 13px; color: var(--text-muted); }

        /* EMPTY/LOADING */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; color: var(--text-secondary); margin-bottom: 8px; }
        .empty-state p { font-size: 14px; }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-muted); }
        .spinner {
            width: 32px; height: 32px; border: 3px solid var(--dark-border); border-top-color: var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* MODAL */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none;
            align-items: center; justify-content: center; z-index: 1000; padding: 20px;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: var(--radius);
            padding: 32px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto;
        }
        .modal h2 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }
        .modal-close { float: right; background: none; color: var(--text-muted); font-size: 20px; }

        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
        .toast {
            padding: 14px 20px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500;
            box-shadow: var(--shadow); animation: slideIn 0.3s ease; max-width: 360px;
        }
        .toast.success { background: #00B894; color: white; }
        .toast.error { background: #D63031; color: white; }
        .toast.info { background: #6C5CE7; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .menu-toggle { display: block; }
            .search-bar { width: 180px; }
            .page-content { padding: 20px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .clubs-grid, .events-grid, .certificates-grid { grid-template-columns: 1fr; }
            .chat-container { grid-template-columns: 1fr; }
            .chat-channels { display: none; }
            .chat-channels.show { display: block; position: absolute; inset: 0; z-index: 10; background: var(--dark-card); }
            .profile-header { flex-direction: column; text-align: center; }
            .form-row { grid-template-columns: 1fr; }
            .calendar-days .calendar-day { min-height: 36px; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<!-- AUTH PAGE -->
<div class="auth-container" id="authPage">
    <div class="auth-card">
        <div id="loginForm">
            <h1>üéì CampusHub</h1>
            <p class="subtitle">Your College Club & Event Manager</p>
            <div class="error-msg" id="loginError"></div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="you@college.edu">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter password"
                       onkeydown="if(event.key==='Enter')handleLogin()">
            </div>
            <button class="btn-primary" id="loginBtn" onclick="handleLogin()">Sign In</button>
            <p class="auth-toggle">Don't have an account? <a onclick="showRegister()">Sign Up</a></p>
        </div>
        <div id="registerForm" style="display:none">
            <h1>üéì CampusHub</h1>
            <p class="subtitle">Create your account</p>
            <div class="error-msg" id="registerError"></div>
            <div class="form-group"><label>Full Name</label><input type="text" id="regName" placeholder="Your full name"></div>
            <div class="form-group"><label>Email</label><input type="email" id="regEmail" placeholder="you@college.edu"></div>
            <div class="form-group"><label>Password</label><input type="password" id="regPassword" placeholder="Min 6 characters"></div>
            <div class="form-row">
                <div class="form-group">
                    <label>Department</label>
                    <select id="regDept"><option value="">Select</option><option>CSE</option><option>ECE</option><option>EEE</option><option>ME</option><option>CE</option><option>IT</option><option>MBA</option><option>Other</option></select>
                </div>
                <div class="form-group">
                    <label>Year</label>
                    <select id="regYear"><option value="">Select</option><option value="1">1st Year</option><option value="2">2nd Year</option><option value="3">3rd Year</option><option value="4">4th Year</option></select>
                </div>
            </div>
            <div class="form-group">
                <label>Register As</label>
                <div class="role-select">
                    <div class="role-option active" onclick="selectRole('student',this)"><span class="role-icon">üéì</span> Student</div>
                    <div class="role-option" onclick="selectRole('admin',this)"><span class="role-icon">‚öôÔ∏è</span> Admin</div>
                </div>
            </div>
            <input type="hidden" id="regRole" value="student">
            <button class="btn-primary" id="registerBtn" onclick="handleRegister()">Create Account</button>
            <p class="auth-toggle">Already have an account? <a onclick="showLogin()">Sign In</a></p>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div class="app-container" id="appContainer">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>üéì CampusHub</h2>
            <div class="user-role" id="sidebarRole">Student Portal</div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section-title">Main</div>
            <div class="nav-item active" onclick="navigateTo('dashboard')" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="navigateTo('clubs')" data-page="clubs"><i class="fas fa-users-rectangle"></i> Clubs</div>
            <div class="nav-item" onclick="navigateTo('events')" data-page="events"><i class="fas fa-calendar-days"></i> Events</div>
            <div class="nav-item" onclick="navigateTo('calendar')" data-page="calendar"><i class="fas fa-calendar"></i> Calendar</div>
            <div class="nav-item" onclick="navigateTo('chat')" data-page="chat"><i class="fas fa-comments"></i> Chat</div>
            <div class="nav-item" onclick="navigateTo('certificates')" data-page="certificates"><i class="fas fa-award"></i> Certificates</div>
            <div class="nav-item" onclick="navigateTo('notifications')" data-page="notifications">
                <i class="fas fa-bell"></i> Notifications
                <span class="nav-badge" id="navNotifBadge" style="display:none">0</span>
            </div>
            <div class="admin-section" id="adminNav">
                <div class="nav-section-title">Admin</div>
                <div class="nav-item" onclick="navigateTo('admin')" data-page="admin"><i class="fas fa-shield-halved"></i> Admin Panel</div>
            </div>
            <div class="nav-section-title">Account</div>
            <div class="nav-item" onclick="navigateTo('profile')" data-page="profile"><i class="fas fa-user"></i> Profile</div>
        </nav>
        <div class="sidebar-footer">
            <div class="user-profile-mini" onclick="navigateTo('profile')">
                <div class="user-avatar" id="sidebarAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="sidebarName">User</div>
                    <div class="user-email" id="sidebarEmail">user@email.com</div>
                </div>
            </div>
        </div>
    </aside>

    <div class="main-content">
        <div class="top-bar">
            <div class="top-bar-left">
                <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                <h1 class="page-title" id="pageTitle">Dashboard</h1>
            </div>
            <div class="top-bar-right">
                <div class="search-bar"><i class="fas fa-search"></i><input type="text" placeholder="Search..." id="globalSearch" onkeyup="handleGlobalSearch(event)"></div>
                <button class="icon-btn" onclick="navigateTo('notifications')"><i class="fas fa-bell"></i><span class="badge" id="topNotifBadge" style="display:none">0</span></button>
                <button class="btn-logout" onclick="handleLogout()"><i class="fas fa-right-from-bracket"></i> Logout</button>
            </div>
        </div>

        <div class="page-content">

            <!-- DASHBOARD -->
            <div class="page active" id="page-dashboard">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(108,92,231,0.15)">üèõÔ∏è</div><div class="stat-value" id="statClubs">0</div><div class="stat-label">Active Clubs</div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(0,206,201,0.15)">üìÖ</div><div class="stat-value" id="statEvents">0</div><div class="stat-label">Total Events</div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(253,121,168,0.15)">üë•</div><div class="stat-value" id="statStudents">0</div><div class="stat-label">Active Students</div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(0,184,148,0.15)">üèÜ</div><div class="stat-value" id="statCerts">0</div><div class="stat-label">Certificates</div></div>
                </div>
                <div class="section-header"><h2>My Clubs</h2></div>
                <div class="clubs-grid" id="myClubsGrid"><div class="loading"><div class="spinner"></div> Loading...</div></div>
                <div style="margin-top:32px"><div class="section-header"><h2>Upcoming Events</h2></div>
                <div class="events-grid" id="dashboardEvents"><div class="loading"><div class="spinner"></div> Loading...</div></div></div>
            </div>

            <!-- CLUBS -->
            <div class="page" id="page-clubs">
                <div class="section-header"><h2>Explore Clubs</h2></div>
                <div class="filter-bar" id="clubFilters">
                    <button class="filter-btn active" onclick="filterClubs('all',this)">All</button>
                    <button class="filter-btn" onclick="filterClubs('Technology',this)">Technology</button>
                    <button class="filter-btn" onclick="filterClubs('Arts & Media',this)">Arts & Media</button>
                    <button class="filter-btn" onclick="filterClubs('Music & Dance',this)">Music & Dance</button>
                    <button class="filter-btn" onclick="filterClubs('Literary',this)">Literary</button>
                    <button class="filter-btn" onclick="filterClubs('Sports',this)">Sports</button>
                    <button class="filter-btn" onclick="filterClubs('Social Service',this)">Social Service</button>
                </div>
                <div class="clubs-grid" id="allClubsGrid"><div class="loading"><div class="spinner"></div> Loading...</div></div>
            </div>

            <!-- EVENTS -->
            <div class="page" id="page-events">
                <div class="section-header"><h2>Events</h2></div>
                <!-- Create Event (Admin Only) -->
                <div class="admin-section create-event-section" id="createEventSection">
                    <h3>üìù Create New Event</h3>
                    <div class="form-group"><label>Event Title</label><input type="text" id="evtTitle" placeholder="Event name"></div>
                    <div class="form-group"><label>Description</label><textarea id="evtDesc" placeholder="Event description"></textarea></div>
                    <div class="form-group"><label>Club</label><select id="evtClub"><option value="">Select Club</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label>Date</label><input type="date" id="evtDate"></div>
                        <div class="form-group"><label>Venue</label><input type="text" id="evtVenue" placeholder="Location"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Start Time</label><input type="time" id="evtStart"></div>
                        <div class="form-group"><label>End Time</label><input type="time" id="evtEnd"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Max Participants</label><input type="number" id="evtMax" value="100"></div>
                        <div class="form-group"><label>Price (‚Çπ)</label><input type="number" id="evtPrice" value="0" step="10"></div>
                    </div>
                    <div class="form-group">
                        <label>Event Type</label>
                        <select id="evtType"><option value="workshop">Workshop</option><option value="competition">Competition</option><option value="seminar">Seminar</option><option value="social">Social</option><option value="meetup">Meetup</option></select>
                    </div>
                    <button class="btn-primary" onclick="createEvent()" style="max-width:200px">Create Event</button>
                </div>
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterEvents('all',this)">All</button>
                    <button class="filter-btn" onclick="filterEvents('upcoming',this)">Upcoming</button>
                    <button class="filter-btn" onclick="filterEvents('completed',this)">Completed</button>
                </div>
                <div class="events-grid" id="allEventsGrid"><div class="loading"><div class="spinner"></div> Loading...</div></div>
            </div>

            <!-- CALENDAR -->
            <div class="page" id="page-calendar">
                <div class="section-header"><h2>üìÖ Event Calendar</h2></div>
                <div class="calendar-container">
                    <div class="calendar-header-bar">
                        <div class="calendar-nav">
                            <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        </div>
                        <h3 id="calendarMonthYear">January 2025</h3>
                        <div class="calendar-nav">
                            <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="calendar-weekdays">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div class="calendar-days" id="calendarDays"></div>
                    <div class="calendar-events-panel" id="calendarEventsPanel">
                        <h4 id="calSelectedDate">Select a date to see events</h4>
                        <div id="calEventsList"></div>
                    </div>
                </div>
            </div>

            <!-- CHAT -->
            <div class="page" id="page-chat">
                <div class="chat-container">
                    <div class="chat-channels" id="chatChannels">
                        <div class="chat-channels-header">üí¨ Club Chats</div>
                        <div id="channelList"><div class="loading"><div class="spinner"></div></div></div>
                    </div>
                    <div class="chat-main" id="chatMain">
                        <div class="chat-no-channel" id="chatPlaceholder">
                            <div style="text-align:center"><div style="font-size:48px;margin-bottom:16px">üí¨</div><p>Select a club to start chatting</p><p style="font-size:12px;margin-top:8px;color:var(--text-muted)">Join a club first to access its chat</p></div>
                        </div>
                        <div id="chatActive" style="display:none;flex-direction:column;height:100%">
                            <div class="chat-header" id="chatHeaderTitle">Club Chat</div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()">
                                <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CERTIFICATES -->
            <div class="page" id="page-certificates">
                <div class="section-header"><h2>üèÜ My Certificates</h2></div>
                <div class="verify-box">
                    <h3>üîç Verify a Certificate</h3>
                    <p style="color:var(--text-secondary);font-size:14px;margin-bottom:16px">Enter verification code to validate a certificate</p>
                    <div class="verify-input-group">
                        <input type="text" id="verifyCode" placeholder="Enter verification code" class="form-group">
                        <button class="btn-sm btn-join" onclick="verifyCertificate()" style="flex:none;width:100px">Verify</button>
                    </div>
                    <div class="verify-result" id="verifyResult"></div>
                </div>
                <div class="certificates-grid" id="certificatesGrid">
                    <div class="loading"><div class="spinner"></div> Loading certificates...</div>
                </div>
            </div>

            <!-- NOTIFICATIONS -->
            <div class="page" id="page-notifications">
                <div class="section-header"><h2>Notifications</h2>
                <button class="btn-sm btn-view" onclick="markAllRead()"><i class="fas fa-check-double"></i> Mark All Read</button></div>
                <div class="notification-list" id="notificationList"><div class="loading"><div class="spinner"></div> Loading...</div></div>
            </div>

            <!-- ADMIN -->
            <div class="page" id="page-admin">
                <div class="section-header"><h2>‚öôÔ∏è Admin Panel</h2></div>
                <div style="margin-bottom:32px">
                    <h3 style="margin-bottom:16px;font-size:18px"><i class="fas fa-user-clock" style="color:var(--warning)"></i> Pending Membership Requests</h3>
                    <div class="pending-list" id="pendingMembersList"><div class="loading"><div class="spinner"></div> Loading...</div></div>
                </div>
                <div>
                    <h3 style="margin-bottom:16px;font-size:18px"><i class="fas fa-building" style="color:var(--primary-light)"></i> Pending Club Approvals</h3>
                    <div class="pending-list" id="pendingClubsList"><div class="loading"><div class="spinner"></div> Loading...</div></div>
                </div>
            </div>

            <!-- PROFILE -->
            <div class="page" id="page-profile">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <div class="profile-details">
                        <h2 id="profileName">User</h2>
                        <div class="profile-email" id="profileEmail">user@email.com</div>
                        <div class="profile-meta">
                            <span id="profileDept"><i class="fas fa-building"></i> Department</span>
                            <span id="profileYear"><i class="fas fa-graduation-cap"></i> Year</span>
                            <span id="profileRole"><i class="fas fa-shield"></i> Role</span>
                        </div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
                    <div class="stat-card"><div class="stat-value" id="profileClubCount">0</div><div class="stat-label">Clubs Joined</div></div>
                    <div class="stat-card"><div class="stat-value" id="profileEventCount">0</div><div class="stat-label">Events Attended</div></div>
                    <div class="stat-card"><div class="stat-value" id="profileCertCount">0</div><div class="stat-label">Certificates</div></div>
                </div>
                <div class="section-header"><h2>Edit Profile</h2></div>
                <div style="max-width:500px">
                    <div class="form-group"><label>Name</label><input type="text" id="editName"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Department</label><select id="editDept"><option value="">Select</option><option>CSE</option><option>ECE</option><option>EEE</option><option>ME</option><option>CE</option><option>IT</option><option>MBA</option><option>Other</option></select></div>
                        <div class="form-group"><label>Year</label><select id="editYear"><option value="">Select</option><option value="1">1st</option><option value="2">2nd</option><option value="3">3rd</option><option value="4">4th</option></select></div>
                    </div>
                    <button class="btn-primary" onclick="updateProfile()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
    <div class="modal" id="modalContent"></div>
</div>

<script>
// ==========================================
// CONFIG
// ==========================================
const API_URL = window.location.origin;
let currentUser = null;
let authToken = null;
let allClubs = [];
let allEvents = [];
let calendarEvents = [];
let currentChatClubId = null;
let chatPollInterval = null;
let calendarDate = new Date();

// ==========================================
// INIT
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('campushub_auth');
    if (saved) {
        const parsed = JSON.parse(saved);
        authToken = parsed.token;
        currentUser = parsed.user;
        showApp();
    }
});

// ==========================================
// API HELPERS
// ==========================================
function authHeaders() {
    return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` };
}

async function apiCall(endpoint, options = {}) {
    const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers: { ...authHeaders(), ...options.headers } });
    const data = await res.json();
    if (!res.ok) {
        if (res.status === 401) { handleLogout(); throw new Error('Session expired'); }
        throw new Error(data.error || 'Something went wrong');
    }
    return data;
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

// ==========================================
// AUTH
// ==========================================
async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');
    const btn = document.getElementById('loginBtn');
    if (!email || !password) { errorEl.textContent = 'Please fill in all fields.'; errorEl.classList.add('show'); return; }
    btn.disabled = true; btn.textContent = 'Signing in...'; errorEl.classList.remove('show');
    try {
        const res = await fetch(`${API_URL}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        authToken = data.token; currentUser = data.user;
        localStorage.setItem('campushub_auth', JSON.stringify({ token: authToken, user: currentUser }));
        showToast('Welcome back, ' + currentUser.name + '!', 'success');
        showApp();
    } catch (err) { errorEl.textContent = err.message; errorEl.classList.add('show'); }
    finally { btn.disabled = false; btn.textContent = 'Sign In'; }
}

async function handleRegister() {
    const name = document.getElementById('regName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    const department = document.getElementById('regDept').value;
    const year = document.getElementById('regYear').value;
    const role = document.getElementById('regRole').value;
    const errorEl = document.getElementById('registerError');
    const btn = document.getElementById('registerBtn');
    if (!name || !email || !password) { errorEl.textContent = 'Please fill in all required fields.'; errorEl.classList.add('show'); return; }
    if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters.'; errorEl.classList.add('show'); return; }
    btn.disabled = true; btn.textContent = 'Creating account...'; errorEl.classList.remove('show');
    try {
        const res = await fetch(`${API_URL}/api/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, name, department, year: year ? parseInt(year) : null, role }) });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error);
        authToken = data.token; currentUser = data.user;
        localStorage.setItem('campushub_auth', JSON.stringify({ token: authToken, user: currentUser }));
        showToast('Account created successfully!', 'success');
        showApp();
    } catch (err) { errorEl.textContent = err.message; errorEl.classList.add('show'); }
    finally { btn.disabled = false; btn.textContent = 'Create Account'; }
}

function selectRole(role, el) {
    document.getElementById('regRole').value = role;
    document.querySelectorAll('.role-option').forEach(o => o.classList.remove('active'));
    el.classList.add('active');
}
function showLogin() { document.getElementById('loginForm').style.display = 'block'; document.getElementById('registerForm').style.display = 'none'; }
function showRegister() { document.getElementById('loginForm').style.display = 'none'; document.getElementById('registerForm').style.display = 'block'; }
function handleLogout() {
    authToken = null; currentUser = null; localStorage.removeItem('campushub_auth');
    if (chatPollInterval) clearInterval(chatPollInterval);
    document.getElementById('authPage').style.display = 'flex';
    document.getElementById('appContainer').classList.remove('active');
    showToast('Logged out', 'info');
}

// ==========================================
// SHOW APP
// ==========================================
function showApp() {
    document.getElementById('authPage').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
    document.getElementById('sidebarAvatar').textContent = initials;
    document.getElementById('sidebarName').textContent = currentUser.name;
    document.getElementById('sidebarEmail').textContent = currentUser.email;
    const isAdmin = currentUser.role === 'admin';
    document.getElementById('sidebarRole').textContent = isAdmin ? 'Admin Portal' : 'Student Portal';
    document.getElementById('adminNav').classList.toggle('show', isAdmin);
    document.getElementById('createEventSection').classList.toggle('show', isAdmin);
    navigateTo('dashboard');
}

// ==========================================
// NAVIGATION
// ==========================================
function navigateTo(page) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
    if (navItem) navItem.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${page}`).classList.add('active');
    const titles = { dashboard:'Dashboard', clubs:'Explore Clubs', events:'Events', calendar:'Calendar', chat:'Chat', certificates:'Certificates', notifications:'Notifications', admin:'Admin Panel', profile:'Profile' };
    document.getElementById('pageTitle').textContent = titles[page] || page;
    document.getElementById('sidebar').classList.remove('open');
    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'clubs': loadAllClubs(); break;
        case 'events': loadAllEvents(); loadClubsForEventForm(); break;
        case 'calendar': loadCalendar(); break;
        case 'chat': loadChatChannels(); break;
        case 'certificates': loadCertificates(); break;
        case 'notifications': loadNotifications(); break;
        case 'admin': loadAdminPanel(); break;
        case 'profile': loadProfile(); break;
    }
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

// ==========================================
// DASHBOARD
// ==========================================
async function loadDashboard() {
    try { const stats = await apiCall('/api/stats'); document.getElementById('statClubs').textContent = stats.activeClubs; document.getElementById('statEvents').textContent = stats.totalEvents; document.getElementById('statStudents').textContent = stats.activeStudents; document.getElementById('statCerts').textContent = stats.certificatesIssued; } catch(e){}
    try {
        const memberships = await apiCall('/api/memberships/my');
        const grid = document.getElementById('myClubsGrid');
        const approved = memberships.filter(m => m.status === 'approved');
        if (approved.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üèõÔ∏è</div><h3>No clubs yet</h3><p>Explore and join clubs!</p><button class="btn-sm btn-join" style="margin-top:12px" onclick="navigateTo(\'clubs\')">Browse Clubs</button></div>'; }
        else { grid.innerHTML = approved.map(m => renderClubCard(m.clubs, 'approved')).join(''); }
    } catch(e) { document.getElementById('myClubsGrid').innerHTML = '<div class="empty-state"><p>Error loading clubs</p></div>'; }
    try {
        const events = await apiCall('/api/events?upcoming=true&limit=4');
        const grid = document.getElementById('dashboardEvents');
        if (events.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üìÖ</div><h3>No upcoming events</h3></div>'; }
        else { grid.innerHTML = events.map(e => renderEventCard(e)).join(''); }
    } catch(e) { document.getElementById('dashboardEvents').innerHTML = '<div class="empty-state"><p>Error loading events</p></div>'; }
    loadNotificationCount();
}

// ==========================================
// CLUBS
// ==========================================
async function loadAllClubs(category = 'all') {
    const grid = document.getElementById('allClubsGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';
    try {
        const params = category !== 'all' ? `?category=${category}` : '';
        allClubs = await apiCall(`/api/clubs${params}`);
        let myMemberships = []; try { myMemberships = await apiCall('/api/memberships/my'); } catch(e){}
        const map = {}; myMemberships.forEach(m => { map[m.clubs.id] = m.status; });
        if (allClubs.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üîç</div><h3>No clubs found</h3></div>'; }
        else { grid.innerHTML = allClubs.map(c => renderClubCard(c, map[c.id])).join(''); }
    } catch(e) { grid.innerHTML = '<div class="empty-state"><p>Error loading clubs</p></div>'; }
}

function renderClubCard(club, status) {
    const colors = (club.color || '#6C5CE7,#A29BFE').split(',');
    let btn = '';
    if (status === 'approved') btn = `<button class="btn-sm btn-joined" disabled>‚úÖ Joined</button><button class="btn-sm btn-leave" onclick="event.stopPropagation();leaveClub('${club.id}')">Leave</button>`;
    else if (status === 'pending') btn = `<button class="btn-sm btn-pending" disabled>‚è≥ Pending</button>`;
    else btn = `<button class="btn-sm btn-join" onclick="event.stopPropagation();joinClub('${club.id}')">Join Club</button>`;
    return `<div class="club-card"><div class="club-card-banner" style="background:linear-gradient(135deg,${colors[0]},${colors[1]||colors[0]})">${club.icon||'üèõÔ∏è'}</div><div class="club-card-body"><span class="badge-category" style="background:${colors[0]}22;color:${colors[0]}">${club.category}</span><h3>${club.name}</h3><p>${club.description||'No description'}</p><div class="club-card-meta"><span class="members"><i class="fas fa-users"></i> ${club.member_count||0} members</span><span class="rating"><i class="fas fa-star"></i> ${club.rating||'0.0'}</span></div></div><div class="club-card-actions">${btn}</div></div>`;
}

function filterClubs(cat, btn) { document.querySelectorAll('#clubFilters .filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadAllClubs(cat); }
async function joinClub(id) { try { await apiCall(`/api/memberships/join/${id}`, {method:'POST'}); showToast('Request sent!','success'); loadAllClubs(); } catch(e) { showToast(e.message,'error'); } }
async function leaveClub(id) { if(!confirm('Leave this club?')) return; try { await apiCall(`/api/memberships/leave/${id}`,{method:'DELETE'}); showToast('Left club','info'); loadAllClubs(); loadDashboard(); } catch(e) { showToast(e.message,'error'); } }

// ==========================================
// EVENTS
// ==========================================
async function loadAllEvents(filter = 'all') {
    const grid = document.getElementById('allEventsGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';
    try {
        let params = ''; if (filter === 'upcoming') params = '?upcoming=true'; else if (filter === 'completed') params = '?status=completed';
        allEvents = await apiCall(`/api/events${params}`);
        if (allEvents.length === 0) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üìÖ</div><h3>No events found</h3></div>'; }
        else { grid.innerHTML = allEvents.map(e => renderEventCard(e)).join(''); }
    } catch(e) { grid.innerHTML = '<div class="empty-state"><p>Error loading events</p></div>'; }
}

function renderEventCard(event) {
    const colors = (event.color || '#6C5CE7,#A29BFE').split(',');
    const clubName = event.clubs ? event.clubs.name : 'Unknown';
    const date = new Date(event.event_date).toLocaleDateString('en-IN', { weekday:'short', month:'short', day:'numeric' });
    const spots = event.max_participants - (event.registered_count || 0);
    return `<div class="event-card"><div class="event-card-banner" style="background:linear-gradient(135deg,${colors[0]},${colors[1]||colors[0]})"><span class="event-icon">${event.icon||'üìÖ'}</span><span class="event-club">${clubName}</span></div><div class="event-card-body"><h3>${event.title}</h3><div class="event-detail"><i class="fas fa-calendar"></i> ${date}</div><div class="event-detail"><i class="fas fa-clock"></i> ${event.start_time} - ${event.end_time}</div><div class="event-detail"><i class="fas fa-location-dot"></i> ${event.venue||'TBA'}</div></div><div class="event-card-footer"><span class="event-spots">${spots > 0 ? spots+' spots left':'Full'}</span><span class="event-price">${event.price > 0 ? '‚Çπ'+event.price:'Free'}</span><button class="btn-sm btn-join" onclick="registerEvent('${event.id}')" ${event.is_full?'disabled style="opacity:0.5"':''}>${event.is_full?'Full':'Register'}</button></div></div>`;
}

function filterEvents(f, btn) { document.querySelectorAll('#page-events .filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadAllEvents(f); }
async function registerEvent(id) { try { await apiCall(`/api/events/${id}/register`,{method:'POST'}); showToast('Registered!','success'); loadAllEvents(); } catch(e) { showToast(e.message,'error'); } }

async function loadClubsForEventForm() {
    if (currentUser.role !== 'admin') return;
    try {
        const clubs = await apiCall('/api/clubs');
        const sel = document.getElementById('evtClub');
        sel.innerHTML = '<option value="">Select Club</option>' + clubs.map(c => `<option value="${c.id}">${c.icon||'üèõÔ∏è'} ${c.name}</option>`).join('');
    } catch(e){}
}

async function createEvent() {
    const title = document.getElementById('evtTitle').value.trim();
    const description = document.getElementById('evtDesc').value.trim();
    const club_id = document.getElementById('evtClub').value;
    const event_date = document.getElementById('evtDate').value;
    const start_time = document.getElementById('evtStart').value;
    const end_time = document.getElementById('evtEnd').value;
    const venue = document.getElementById('evtVenue').value.trim();
    const max_participants = parseInt(document.getElementById('evtMax').value) || 100;
    const price = parseFloat(document.getElementById('evtPrice').value) || 0;
    const event_type = document.getElementById('evtType').value;
    if (!title || !club_id || !event_date || !start_time || !end_time) { showToast('Fill all required fields','error'); return; }
    try {
        await apiCall('/api/events', { method:'POST', body: JSON.stringify({ title, description, club_id, event_date, start_time, end_time, venue, max_participants, price, event_type }) });
        showToast('Event created!','success');
        document.getElementById('evtTitle').value = ''; document.getElementById('evtDesc').value = '';
        document.getElementById('evtVenue').value = ''; document.getElementById('evtDate').value = '';
        document.getElementById('evtStart').value = ''; document.getElementById('evtEnd').value = '';
        loadAllEvents();
    } catch(e) { showToast(e.message,'error'); }
}

// ==========================================
// CALENDAR
// ==========================================
async function loadCalendar() {
    try { calendarEvents = await apiCall('/api/events'); } catch(e) { calendarEvents = []; }
    renderCalendar();
}

function renderCalendar() {
    const year = calendarDate.getFullYear();
    const month = calendarDate.getMonth();
    const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    const today = new Date();

    // Build event date set
    const eventDates = {};
    calendarEvents.forEach(e => {
        const d = e.event_date; // YYYY-MM-DD
        if (!eventDates[d]) eventDates[d] = [];
        eventDates[d].push(e);
    });

    let html = '';
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`;
    }
    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === d;
        const hasEvent = eventDates[dateStr];
        const classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (hasEvent) classes.push('has-event');
        html += `<div class="${classes.join(' ')}" onclick="selectCalendarDate('${dateStr}')">${d}</div>`;
    }
    // Next month days
    const totalCells = firstDay + daysInMonth;
    const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 1; i <= remaining; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
    }
    document.getElementById('calendarDays').innerHTML = html;
    document.getElementById('calSelectedDate').textContent = 'Select a date to see events';
    document.getElementById('calEventsList').innerHTML = '';
}

function changeMonth(delta) {
    calendarDate.setMonth(calendarDate.getMonth() + delta);
    renderCalendar();
}

function selectCalendarDate(dateStr) {
    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
    event.target.classList.add('selected');
    const dateObj = new Date(dateStr + 'T00:00:00');
    const formatted = dateObj.toLocaleDateString('en-IN', { weekday:'long', month:'long', day:'numeric', year:'numeric' });
    document.getElementById('calSelectedDate').textContent = `Events on ${formatted}`;

    const dayEvents = calendarEvents.filter(e => e.event_date === dateStr);
    const list = document.getElementById('calEventsList');
    if (dayEvents.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:8px 0">No events on this date</p>';
    } else {
        list.innerHTML = dayEvents.map(e => {
            const colors = (e.color || '#6C5CE7,#A29BFE').split(',');
            const clubName = e.clubs ? e.clubs.name : '';
            return `<div class="cal-event-item"><div class="cal-event-dot" style="background:${colors[0]}"></div><div class="cal-event-info"><div class="cal-event-title">${e.icon||'üìÖ'} ${e.title}</div><div class="cal-event-time">${e.start_time} - ${e.end_time} ‚Ä¢ ${e.venue||'TBA'} ‚Ä¢ ${clubName}</div></div><button class="btn-sm btn-join" style="flex:none" onclick="registerEvent('${e.id}')">Register</button></div>`;
        }).join('');
    }
}

// ==========================================
// CHAT
// ==========================================
async function loadChatChannels() {
    const list = document.getElementById('channelList');
    try {
        const channels = await apiCall('/api/chat');
        if (channels.length === 0) { list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px">Join a club to start chatting</div>'; }
        else { list.innerHTML = channels.map(ch => { const colors = (ch.color||'#6C5CE7,#A29BFE').split(','); const last = ch.last_message ? `${ch.last_message.sender}: ${ch.last_message.text}`.substring(0,30)+'...' : 'No messages yet'; return `<div class="channel-item ${currentChatClubId===ch.id?'active':''}" onclick="openChat('${ch.id}','${ch.name.replace(/'/g,"\\'")}','${ch.icon||'üí¨'}')"><div class="channel-icon" style="background:linear-gradient(135deg,${colors[0]},${colors[1]||colors[0]})">${ch.icon||'üí¨'}</div><div class="channel-info"><div class="channel-name">${ch.name}</div><div class="channel-last-msg">${last}</div></div></div>`; }).join(''); }
    } catch(e) { list.innerHTML = '<div style="padding:20px;color:var(--text-muted)">Error loading channels</div>'; }
}

async function openChat(clubId, clubName, icon) {
    currentChatClubId = clubId;
    document.getElementById('chatPlaceholder').style.display = 'none';
    document.getElementById('chatActive').style.display = 'flex';
    document.getElementById('chatHeaderTitle').textContent = `${icon} ${clubName}`;
    document.querySelectorAll('.channel-item').forEach(c => c.classList.remove('active'));
    if (event && event.currentTarget) event.currentTarget.classList.add('active');
    await loadMessages();
    if (chatPollInterval) clearInterval(chatPollInterval);
    chatPollInterval = setInterval(loadMessages, 3000);
}

async function loadMessages() {
    if (!currentChatClubId) return;
    try {
        const messages = await apiCall(`/api/chat/${currentChatClubId}/messages`);
        const container = document.getElementById('chatMessages');
        container.innerHTML = messages.map(msg => {
            const isOwn = msg.sender_id === currentUser.id;
            const sender = msg.users ? msg.users.name : 'Unknown';
            const initials = sender.split(' ').map(n => n[0]).join('').toUpperCase();
            const time = new Date(msg.sent_at).toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
            return `<div class="chat-msg ${isOwn?'own':''}"><div class="chat-msg-avatar">${initials}</div><div class="chat-msg-bubble"><div class="chat-msg-sender">${isOwn?'You':sender}</div><div class="chat-msg-text">${escapeHtml(msg.message)}</div><div class="chat-msg-time">${time}</div></div></div>`;
        }).join('');
        container.scrollTop = container.scrollHeight;
    } catch(e){}
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || !currentChatClubId) return;
    input.value = '';
    try { await apiCall(`/api/chat/${currentChatClubId}/messages`, { method:'POST', body: JSON.stringify({message}) }); await loadMessages(); } catch(e) { showToast(e.message,'error'); }
}

// ==========================================
// CERTIFICATES
// ==========================================
async function loadCertificates() {
    const grid = document.getElementById('certificatesGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div> Loading certificates...</div>';
    try {
        const certs = await apiCall('/api/certificates');
        if (!certs || certs.length === 0) {
            grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üèÜ</div><h3>No certificates yet</h3><p>Attend events and get certified!</p></div>';
        } else {
            grid.innerHTML = certs.map(cert => {
                const date = new Date(cert.issued_at).toLocaleDateString('en-IN', { month:'short', day:'numeric', year:'numeric' });
                const eventTitle = cert.events ? cert.events.title : 'Event';
                const clubName = cert.events && cert.events.clubs ? cert.events.clubs.name : '';
                return `<div class="cert-card"><div class="cert-card-top"><div class="cert-icon">üèÜ</div><h3>${eventTitle}</h3><div class="cert-type">${cert.certificate_type || 'Participation'} Certificate</div></div><div class="cert-card-body"><div class="cert-detail"><span class="cert-label">Club</span><span class="cert-value">${clubName}</span></div><div class="cert-detail"><span class="cert-label">Issued</span><span class="cert-value">${date}</span></div><div class="cert-detail"><span class="cert-label">Code</span><span class="cert-value" style="color:var(--primary-light)">${cert.verification_code || 'N/A'}</span></div></div><div class="cert-card-actions"><button class="btn-download" onclick="downloadCertificate('${cert.id}')"><i class="fas fa-download"></i> Download</button><button class="btn-verify" onclick="navigator.clipboard.writeText('${cert.verification_code||''}');showToast('Code copied!','success')"><i class="fas fa-copy"></i></button></div></div>`;
            }).join('');
        }
    } catch(e) { grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üèÜ</div><h3>No certificates yet</h3><p>Attend events and get certified!</p></div>'; }
}

function downloadCertificate(id) {
    showToast('Certificate download will be available soon!', 'info');
}

async function verifyCertificate() {
    const code = document.getElementById('verifyCode').value.trim();
    const result = document.getElementById('verifyResult');
    if (!code) { showToast('Enter a verification code','error'); return; }
    try {
        const data = await apiCall(`/api/certificates/verify/${code}`);
        result.className = 'verify-result show valid';
        result.innerHTML = `<p><strong>‚úÖ Valid Certificate</strong></p><p>Issued to: ${data.user_name || 'Student'}</p><p>Event: ${data.event_title || 'Event'}</p><p>Issued: ${data.issued_at ? new Date(data.issued_at).toLocaleDateString() : 'N/A'}</p>`;
    } catch(e) {
        result.className = 'verify-result show invalid';
        result.innerHTML = `<p><strong>‚ùå Invalid Code</strong></p><p>No certificate found with this code.</p>`;
    }
}

// ==========================================
// NOTIFICATIONS
// ==========================================
async function loadNotifications() {
    const list = document.getElementById('notificationList');
    try {
        const data = await apiCall('/api/notifications');
        const notifs = data.notifications || [];
        updateNotificationBadges(data.unread_count || 0);
        if (notifs.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üîî</div><h3>No notifications</h3><p>You\'re all caught up!</p></div>'; }
        else { list.innerHTML = notifs.map(n => { const time = timeAgo(n.created_at); return `<div class="notification-item ${n.is_read?'':'unread'}" onclick="markRead('${n.id}',this)"><span class="notif-icon">${n.icon||'üîî'}</span><div class="notif-content"><div class="notif-title">${n.title}</div><div class="notif-msg">${n.message||''}</div><div class="notif-time">${time}</div></div></div>`; }).join(''); }
    } catch(e) { list.innerHTML = '<div class="empty-state"><p>Error loading notifications</p></div>'; }
}

async function loadNotificationCount() { try { const data = await apiCall('/api/notifications?unread_only=true'); updateNotificationBadges(data.unread_count || 0); } catch(e){} }
function updateNotificationBadges(count) {
    const nav = document.getElementById('navNotifBadge'); const top = document.getElementById('topNotifBadge');
    if (count > 0) { nav.textContent = count; nav.style.display = 'block'; top.textContent = count; top.style.display = 'flex'; }
    else { nav.style.display = 'none'; top.style.display = 'none'; }
}
async function markRead(id, el) { try { await apiCall(`/api/notifications/${id}/read`,{method:'PATCH'}); el.classList.remove('unread'); loadNotificationCount(); } catch(e){} }
async function markAllRead() { try { await apiCall('/api/notifications/read-all',{method:'PATCH'}); showToast('All marked as read','success'); loadNotifications(); } catch(e){ showToast(e.message,'error'); } }

// ==========================================
// ADMIN PANEL
// ==========================================
async function loadAdminPanel() {
    if (currentUser.role !== 'admin') { document.getElementById('page-admin').innerHTML = '<div class="empty-state"><div class="empty-icon">üîí</div><h3>Access Denied</h3><p>Admin privileges required.</p></div>'; return; }
    const membersList = document.getElementById('pendingMembersList');
    try {
        const clubs = await apiCall('/api/clubs');
        let allPending = [];
        for (const club of clubs) { try { const pending = await apiCall(`/api/memberships/pending/${club.id}`); pending.forEach(p => { allPending.push({...p, clubName: club.name}); }); } catch(e){} }
        if (allPending.length === 0) { membersList.innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><h3>No pending requests</h3></div>'; }
        else { membersList.innerHTML = allPending.map(p => { const user = p.users || {}; const initials = (user.name||'U').split(' ').map(n=>n[0]).join('').toUpperCase(); return `<div class="pending-item" id="pending-${p.id}"><div class="pending-info"><div class="pending-avatar">${initials}</div><div><div class="pending-name">${user.name||'Unknown'}</div><div class="pending-detail">${user.department||''} ‚Ä¢ Wants to join ${p.clubName}</div></div></div><div class="pending-actions"><button class="btn-approve" onclick="handleMembership('${p.id}','approved')">Approve</button><button class="btn-reject" onclick="handleMembership('${p.id}','rejected')">Reject</button></div></div>`; }).join(''); }
    } catch(e) { membersList.innerHTML = '<div class="empty-state"><p>Error loading</p></div>'; }
    document.getElementById('pendingClubsList').innerHTML = '<div class="empty-state"><div class="empty-icon">‚úÖ</div><h3>No pending clubs</h3></div>';
}

async function handleMembership(id, status) { try { await apiCall(`/api/memberships/${id}/approve`,{method:'PATCH',body:JSON.stringify({status})}); showToast(`Membership ${status}!`, status==='approved'?'success':'info'); document.getElementById(`pending-${id}`).remove(); } catch(e) { showToast(e.message,'error'); } }

// ==========================================
// PROFILE
// ==========================================
async function loadProfile() {
    try {
        const user = await apiCall('/api/auth/me'); currentUser = {...currentUser, ...user};
        const initials = user.name.split(' ').map(n=>n[0]).join('').toUpperCase();
        document.getElementById('profileAvatar').textContent = initials;
        document.getElementById('profileName').textContent = user.name;
        document.getElementById('profileEmail').textContent = user.email;
        document.getElementById('profileDept').innerHTML = `<i class="fas fa-building"></i> ${user.department||'Not set'}`;
        document.getElementById('profileYear').innerHTML = `<i class="fas fa-graduation-cap"></i> ${user.year?'Year '+user.year:'Not set'}`;
        document.getElementById('profileRole').innerHTML = `<i class="fas fa-shield"></i> ${user.role}`;
        document.getElementById('profileClubCount').textContent = (user.clubs||[]).length;
        document.getElementById('profileEventCount').textContent = user.eventsAttended||0;
        document.getElementById('profileCertCount').textContent = user.certificates||0;
        document.getElementById('editName').value = user.name||'';
        document.getElementById('editDept').value = user.department||'';
        document.getElementById('editYear').value = user.year||'';
    } catch(e) { showToast('Error loading profile','error'); }
}

async function updateProfile() {
    try {
        const data = await apiCall('/api/auth/profile', { method:'PUT', body: JSON.stringify({ name: document.getElementById('editName').value, department: document.getElementById('editDept').value, year: parseInt(document.getElementById('editYear').value)||null }) });
        currentUser = {...currentUser, ...data.user};
        localStorage.setItem('campushub_auth', JSON.stringify({token:authToken,user:currentUser}));
        const initials = currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase();
        document.getElementById('sidebarAvatar').textContent = initials;
        document.getElementById('sidebarName').textContent = currentUser.name;
        showToast('Profile updated!','success'); loadProfile();
    } catch(e) { showToast(e.message,'error'); }
}

// ==========================================
// SEARCH
// ==========================================
async function handleGlobalSearch(event) {
    if (event.key !== 'Enter') return;
    const q = event.target.value.trim(); if (!q) return;
    navigateTo('clubs');
    const grid = document.getElementById('allClubsGrid');
    grid.innerHTML = '<div class="loading"><div class="spinner"></div> Searching...</div>';
    try {
        const clubs = await apiCall(`/api/clubs?search=${encodeURIComponent(q)}`);
        let my = []; try { my = await apiCall('/api/memberships/my'); } catch(e){}
        const map = {}; my.forEach(m => { map[m.clubs.id] = m.status; });
        if (clubs.length === 0) grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üîç</div><h3>No results for "${q}"</h3></div>`;
        else grid.innerHTML = clubs.map(c => renderClubCard(c, map[c.id])).join('');
    } catch(e) { grid.innerHTML = '<div class="empty-state"><p>Search error</p></div>'; }
}

// ==========================================
// UTILITIES
// ==========================================
function openModal(content) { document.getElementById('modalContent').innerHTML = content; document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }
function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
function timeAgo(dateStr) {
    const s = Math.floor((new Date() - new Date(dateStr)) / 1000);
    if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s/60)+'m ago';
    if (s < 86400) return Math.floor(s/3600)+'h ago'; if (s < 604800) return Math.floor(s/86400)+'d ago';
    return new Date(dateStr).toLocaleDateString();
}
</script>
</body>
</html>